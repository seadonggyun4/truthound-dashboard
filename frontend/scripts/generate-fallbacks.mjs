/**
 * Generate English fallback data from Intlayer content files
 *
 * This script extracts English (en) values from all .content.ts files
 * and generates a fallbacks.ts file that can be used when Intlayer
 * fails to load at runtime.
 */

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const contentDir = path.join(__dirname, '../src/content')
const outputFile = path.join(__dirname, '../src/lib/intlayer-fallbacks.ts')

/**
 * Extract English values from content file source code
 */
function extractEnglishValues(content) {
  const result = {}

  // Match t({ en: '...', ... }) patterns
  // Handle both single-line and multi-line patterns
  const tCallRegex = /(\w+):\s*t\(\s*\{([^}]+)\}\s*\)/gs

  let match
  while ((match = tCallRegex.exec(content)) !== null) {
    const key = match[1]
    const props = match[2]

    // Extract the 'en' value
    // Handle both: en: 'value' and en: "value"
    const enMatch = props.match(/en:\s*['"]([^'"]*)['"]/s)
    if (enMatch) {
      result[key] = enMatch[1]
    }
  }

  return result
}

/**
 * Get the key name from content file
 */
function extractKey(content) {
  const keyMatch = content.match(/key:\s*['"](\w+)['"]/s)
  return keyMatch ? keyMatch[1] : null
}

// Main execution
console.log('Generating English fallbacks from content files...\n')

const contentFiles = fs.readdirSync(contentDir)
  .filter(f => f.endsWith('.content.ts'))

const fallbacks = {}

for (const file of contentFiles) {
  const filePath = path.join(contentDir, file)
  const content = fs.readFileSync(filePath, 'utf-8')

  const key = extractKey(content)
  if (!key) {
    console.warn(`  Warning: Could not extract key from ${file}`)
    continue
  }

  const englishValues = extractEnglishValues(content)
  const valueCount = Object.keys(englishValues).length

  if (valueCount > 0) {
    fallbacks[key] = englishValues
    console.log(`  ✓ ${key}: ${valueCount} values`)
  } else {
    console.warn(`  Warning: No English values found in ${file}`)
  }
}

// Generate TypeScript output
const output = `/**
 * Auto-generated English fallbacks for Intlayer content
 *
 * Generated by: scripts/generate-fallbacks.mjs
 *
 * These fallbacks are used when Intlayer fails to load dictionaries
 * at runtime (e.g., in Vercel deployments).
 *
 * DO NOT EDIT MANUALLY - regenerate with: node scripts/generate-fallbacks.mjs
 */

// Type for IntlayerNode compatibility (string wrapper that works with React)
type FallbackValue = string

// Type for nested content structure
type FallbackContent = Record<string, FallbackValue | Record<string, FallbackValue>>

export const fallbacks: Record<string, FallbackContent> = ${JSON.stringify(fallbacks, null, 2)} as const

export type FallbackKeys = keyof typeof fallbacks

export function getFallback<K extends FallbackKeys>(key: K): typeof fallbacks[K] {
  return fallbacks[key] || {}
}
`

fs.writeFileSync(outputFile, output, 'utf-8')

console.log(`\n✓ Generated ${outputFile}`)
console.log(`  Total keys: ${Object.keys(fallbacks).length}`)
console.log(`  Total values: ${Object.values(fallbacks).reduce((acc, v) => acc + Object.keys(v).length, 0)}`)
